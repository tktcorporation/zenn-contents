---
title: "pysen ã‚’ä½¿ã£ã¦ python ã® lint ç’°å¢ƒã‚’ã¾ã¨ã‚ã‚‹"
emoji: "ğŸ°"
type: "tech"
topics: ["vscode", "lint", "poetry", "format", "pyrhon"]
published: true
---

# pysen ã¨ã¯

https://github.com/pfnet/pysen

[https://github.com/pfnet/pysen](https://github.com/pfnet/pysen)

> ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ä¸»ã«Pythonå‘ã‘ã®linter/formatterã®è¨­å®šã‚’ä¸€å…ƒç®¡ç†ã—ã€Preferred Networksç¤¾å†…ã§ã‚ˆãä½¿ã‚ã‚Œã¦ã„ã‚‹ãƒ„ãƒ¼ãƒ«ç’°å¢ƒã‚’èª°ã§ã‚‚ç°¡å˜ã«è¨­å®šã§ãã‚‹ã‚ˆã†ã«æ”¯æ´ã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚ãƒãƒ¼ãƒ ã”ã¨ã«åˆ†æ•£ã—ã†ã‚‹ã‚ˆã†ãªãƒ„ãƒ¼ãƒ«ã«é–¢ã™ã‚‹ãƒã‚¦ãƒã‚¦ã‚’ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦é›†ç´„ã—ã€PFNç¤¾å†…ã§ã®å…±æœ‰ã‚’ä¿ƒé€²ã•ã›ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã—ã¦é–‹ç™ºã—ã¦ã„ã¾ã™ã€‚pysenã¯å®Ÿéš›ã«PFNç¤¾å†…ã§ä½¿ã‚ã‚Œã¦ãŠã‚Šã€2020å¹´4æœˆã«é–‹ç™ºãŒã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ã‹ã‚‰ã€2021å¹´3æœˆç¾åœ¨ã§ãŠã‚ˆã100ã‚’è¶…ãˆã‚‹ç¤¾å†…ãƒªãƒã‚¸ãƒˆãƒªã«å°å…¥ã•ã‚Œã¦ã„ã¾ã™ã€‚

[Pythonã®linter/formatterã‚’èª°ã§ã‚‚æ‰‹è»½ã«è¨­å®šã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®PFNç¤¾å†…ãƒ„ãƒ¼ãƒ« â€œpysenâ€ ã®ç´¹ä»‹](https://tech.preferred.jp/ja/blog/pysen-is-the-new-sempai/) ã‚ˆã‚Šå¼•ç”¨

## ã§ãã‚‹ã“ã¨

-   black, mypy, flake8, isort ã® lint ã®åŒæ™‚å®Ÿè¡Œ
-   black, isort ã‚’ä½¿ã£ãŸ format ã®å®Ÿè¡Œ

pysen ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€ä¸Šè¨˜ã®ã‚ˆã†ãªã€è¤‡æ•°ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã£ãŸ lint, format ãŒã€pysen ã®æ”¯é…ä¸‹ã§ç°¡å˜ã«è¡Œãˆã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

## ã‹ã‚†ã„ã¨ã“ã‚ã«æ‰‹ãŒå±Šããƒã‚¤ãƒ³ãƒˆ

å„ pysen ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ã€ pysen ã‚’çµŒç”±ã›ãšã«ç›´æ¥å®Ÿè¡Œã™ã‚‹ã“ã¨ã‚‚ã§ãã‚‹ã®ã§ã€pysen ã«ä¸€æ°—ã«ä¹—ã‚Šæ›ãˆã‚‹ã®ã¯æ€–ã„ã‘ã©â€¦ã¿ãŸã„ãªå ´åˆã«ã‚‚ãŠæ‰‹è»½ã«å°å…¥ã§ãã¾ã™ã€‚

# ã“ã“ã§ã‚„ã‚‹ã“ã¨

pysen ã®ç°¡å˜ãªä½¿ã„æ–¹ã¨ã€vscode ã¨ã®é€£æºæ–¹æ³•ã«ã¤ã„ã¦ã€è‡ªåˆ†ã§ä½œæ¥­ã—ã¦ã„ã¦å°‘ã—è©°ã¾ã£ãŸãƒã‚¤ãƒ³ãƒˆã¨ã¨ã‚‚ã«ã€é †ã«æ›¸ã„ã¦ã„ãã¾ã™ã€‚

# ç’°å¢ƒ

-   OS
    -   Ubuntu
-   Docker
    -   python:3.9-slim
-   ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«
    -   poetry
-   ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
    -   django

# ä½¿ã£ã¦ã¿ã‚‹

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
poetry add -D pysen -E lint
```

ã“ã‚Œã§ pysen ç”¨ã®ä¾å­˜é–¢ä¿‚è«¸ã€…ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã€‚  
`poetry add -D pysen` ã ã‘ã ã¨ã€åˆæœŸçŠ¶æ…‹ã§ã¯ä¾å­˜ãŒè¶³ã‚Šãªã„ã®ã§æ³¨æ„ã€‚

### git ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œæ™‚ã« git ã‚’ä½¿ã†ã®ã§ã€docker ã‚’ä½¿ã£ã¦ã„ã‚‹ã¨ã‹ã§ç’°å¢ƒã«ãªã„å ´åˆã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦å‘¼ã³å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¦ãŠãã€‚

## è¨­å®š

pysen ç”¨ã®è¨­å®šã‚’ `pyproject.toml` ã«è¿½è¨˜ã™ã‚‹ã€‚

pyproject.toml

```toml
[tool.pysen]
version = "0.9"

[tool.pysen.lint]
enable_black = true
enable_flake8 = true
enable_isort = true
enable_mypy = true
mypy_preset = "strict"
line_length = 88
py_version = "py37"
[[tool.pysen.lint.mypy_targets]]
  paths = ["."]
```

### ã‚‚ã£ã¨ç´°ã‹ã„è¨­å®š

```bash
pysen generate .
```

ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€ç´°ã‹ã„è¨­å®šç”¨ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã‚‹ã®ã§ã€ãã‚Œã‚’é€šã˜ã¦è¡Œã†ã€‚(ã‚ã¾ã‚Šç¢ºèªã§ãã¦ãªã„)  
æ”¹ã‚ã¦ç¢ºèªã™ã‚‹ã¨ã€è¨­å®šã‚’exportã™ã‚‹ã ã‘ã§ã€ã“ã“ã®è¨­å®šãŒé©ç”¨ã•ã‚Œã‚‹ã¨ã¯æ›¸ã„ã¦ã„ãªã„æ°—ãŒã™ã‚‹ã€‚`builder` ã§ç´°ã‹ãè¨­å®šã™ã‚‹ã‚ˆã†ãªã“ã¨ã‚‚æ›¸ã„ã¦ã‚ã£ãŸã®ã§ã€ç´°ã‹ã„èª¿æ•´ã¯ãã£ã¡ã§ã™ã‚‹ã®ã‹ã‚‚ã€‚ç¢ºèªã§ããŸã‚‰ã¾ãŸæ›´æ–°ã™ã‚‹ã€‚  
ref: [https://github.com/pfnet/pysen#how-it-works-settings-file-directory](https://github.com/pfnet/pysen#how-it-works-settings-file-directory)

## å®Ÿè¡Œ

### lint

-   black
-   flake8
-   isort
-   mypy

ä¸Šè¨˜ã®ãƒ„ãƒ¼ãƒ«ã‚’çµ„ã¿åˆã‚ã›ã¦å®Ÿè¡Œã•ã‚Œã€ãã‚Œãã‚Œã®é …ç›®ã§ lint ã®å®Ÿè¡Œçµæœã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

```bash
pysen run lint
```

```bash
# ä¾‹
Running commands concurrently...
... concurrent execution done
Running: black
Checking 6 files
error: cannot format /workspace/django_pysen/settings.py: Cannot parse: 16:8: BASE_DIR ã€€ã€€= Path(__file__).resolve().parent.parent
Oh no! ğŸ’¥ ğŸ’” ğŸ’¥
5 files would be left unchanged, 1 file would fail to reformat.
Running: flake8
Checking 6 files
/workspace/django_pysen/settings.py:16:9: E221 multiple spaces before operator
/workspace/django_pysen/settings.py:16:10: E999 SyntaxError: invalid non-printable character U+3000
Running: isort
Checking 6 files
Running: mypy
[1/1] Checking 1 entries
/workspace/django_pysen/settings.py:16: error: invalid non-printable character
U+3000  [syntax]
    BASE_DIR ã€€ã€€= Path(__file__).resolve().parent.parent
              ^
Found 1 error in 1 file (checked 6 source files)

 ** execution summary **
isort .......... OK (0.48 sec)
black .......... Failed (0.41 sec)
flake8 .......... Failed (0.46 sec)
mypy .......... Failed (0.31 sec)

lint finished with error(s)
Errored:
 - black
 - flake8
 - mypy
```

### format

lint ã§ãƒã‚§ãƒƒã‚¯ã—ãŸé …ç›®ã®ã†ã¡ã€è‡ªå‹•ä¿®æ­£ãŒå¯èƒ½ãªé …ç›®ã«å¯¾ã—ã¦å¤‰æ›´ãŒã‹ã‹ã‚‹ã€‚

```bash
pysen run format
```

```bash
# ä¾‹
Running commands
Running: isort
Checking 6 files
Running: black
Checking 6 files
reformatted /workspace/django_pysen/wsgi.py
reformatted /workspace/django_pysen/settings.py
All done! âœ¨ ğŸ° âœ¨
2 files reformatted, 4 files left unchanged.

 ** execution summary **
isort .......... OK (0.40 sec)
black .......... OK (0.35 sec)
```

## ãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã”ã¨ã«å®Ÿè¡Œ

`run_files` ã‚’ä½¿ã†ã“ã¨ã§ã€path æŒ‡å®šã§ã€ãã‚Œä»¥ä¸‹ã«å¯¾ã—ã¦ lint or format ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã§ãã‚‹ã€‚

```bash
pysen run_files lint {path}
```

# VSCode ã§ä½¿ã£ã¦ã¿ã‚‹

https://twitter.com/bonprosoft/status/1375819767915769858

[https://twitter.com/bonprosoft/status/1375819767915769858](https://twitter.com/bonprosoft/status/1375819767915769858)

## æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

![](https://storage.googleapis.com/zenn-user-upload/jemxl32mf3hli8rw4oyk2fl9cbrx)

`ms-python.python` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ã„ã‚‹ã¨ã“ã®å¾Œå…¥ã‚Œã‚‹ pysen å´ã®æ‹¡å¼µæ©Ÿèƒ½ã¨è¡çªã™ã‚‹ã®ã§ã€å…ˆã«å¤–ã—ã¦ãŠãã€‚

## pysen-ls

VSCode ã¨é€£æºã™ã‚‹ãŸã‚ã«ã€pysen ã«å¯¾å¿œã—ãŸ language server ã‚’å…¥ã‚Œã‚‹ã€‚  
ï¼ˆpyproject ã« pysen-ls ã®è¨˜è¿°ãŒå…¥ã£ã¦ã—ã¾ã†ãŸã‚ã€ poetry ã§å…¥ã‚Œãªã„ã»ã†ãŒè‰¯ã„ã®ã‹ã‚‚ã—ã‚Œãªã„ï¼Ÿ)

```bash
poetry add -D pysen-ls
```

## æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

![](https://storage.googleapis.com/zenn-user-upload/xpori4ry1qvq7861slkmpkcbgqaz)

`bonprosoft.pysen-vscode` ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã€‚

## å‹•ãã‚’ç¢ºèªã™ã‚‹

![](https://storage.googleapis.com/zenn-user-upload/6vmwxr67slyyc6lyprgqc7fky8j2)

`formatOnSave` ã«æŒ‡å®šã™ã‚‹ã‚‚ã‚ˆã—ã€`Format Current Document` ã§å®Ÿè¡Œã™ã‚‹ã‚‚ã‚ˆã—ã€‚

![](https://storage.googleapis.com/zenn-user-upload/ykaoupbiy6cf7t8o5aw0q1cx2m0n)

PROBLEMS ã®ã‚¿ãƒ–ã§ã‚‚ã¡ã‚ƒã‚“ã¨ç¢ºèªã§ãã‚‹ã€‚

# å‚è€ƒ

-   [https://github.com/pfnet/pysen](https://github.com/pfnet/pysen)
-   [https://tech.preferred.jp/ja/blog/pysen-is-the-new-sempai/](https://tech.preferred.jp/ja/blog/pysen-is-the-new-sempai/)
-   [https://twitter.com/bonprosoft/status/1375819767915769858](https://twitter.com/bonprosoft/status/1375819767915769858)

# ä½œæ¥­ãƒ­ã‚°

-   [https://zenn.dev/tktcorporation/scraps/d683ce5123883b](https://zenn.dev/tktcorporation/scraps/d683ce5123883b)

# å‹•ä½œç¢ºèªç”¨ repository

-   [https://github.com/tktcorporation/django-poetry-pysen-sample](https://github.com/tktcorporation/django-poetry-pysen-sample)