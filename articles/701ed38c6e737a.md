---
title: "Rust ã§å¤–éƒ¨ä¾å­˜ã«å¯¾ã—ã¦ mock test ã‚’æ›¸ã"
emoji: "ğŸ§"
type: "tech"
topics: ["rust", "test", "mock", "mockall"]
published: true
---

# ç›®çš„

å¤–éƒ¨ã® crate ã«ä¾å­˜ã—ã¦ã„ã‚‹å ´åˆãªã©ã§ã€ãƒ†ã‚¹ãƒˆãŒç´ ç›´ã«æ›¸ã‘ãªã„å•é¡Œã‚’è§£æ±ºã—ãŸã„ã€‚

# æ–¹é‡

https://github.com/asomers/mockall

[https://github.com/asomers/mockall](https://github.com/asomers/mockall)  
`mockall` ã¨ã„ã† mock test ç”¨ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã£ã¦ä¾å­˜éƒ¨åˆ†ã‚’ mock ã—ã¦ãƒ†ã‚¹ãƒˆã‚’æ›¸ãã€‚  
ä¾å­˜éƒ¨åˆ†ã‚’ç›´æ¥ mock ã™ã‚‹ã“ã¨ã¯ã§ããªã‹ã£ãŸã®ã§ã€trait ã§ interface éƒ¨åˆ†ã‚’å®šç¾©ã—ã¦ã€ãã“ã‚’ mock ã™ã‚‹å½¢ã‚’å–ã‚‹ã€‚

# æ‰‹é †

## mockall ã‚’å…¥ã‚Œã‚‹

Cargo.toml

```toml
[dependencies]
mockall = "^0.10.2"
```

## interface ã¨ãªã‚‹ trait ã‚’å®šç¾©ã™ã‚‹

```rust
#[async_trait]
pub trait Printer {
    // `&str` ã®éƒ¨åˆ†ã‚’ external crate ã‚’ä½¿ã£ã¦æ›¸ã‘ã‚‹
    async fn print(&self, message: &str);
}
```

## interface ã‚’ mock åŒ–ã™ã‚‹

```rust
#[cfg_attr(test, mockall::automock)]
#[async_trait]
pub trait Printer {
    async fn print(&self, &str);
}
```

## trait ã‚’ä½¿ã†é–¢æ•°ã‚’å®šç¾©ï¼ˆãƒ†ã‚¹ãƒˆã—ãŸã„é–¢æ•°ï¼‰

```rust
pub async fn printer_print(printer: &Printer) {
    printer.print("hoge")
    .await;
}
```

## ãƒ†ã‚¹ãƒˆã‚’æ›¸ã

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[tokio::test]
    async fn test_printer_print() {
        // `#[cfg_attr(test, mockall::automock)]` ã§å®šç¾©ã™ã‚‹ã¨ `MockHoge` ã®å½¢ã§å‘¼ã¹ã‚‹ã‚ˆã†ã«ãªã‚‹
        let mut printer = MockPrinter::new();

        // `expect_hoge` ã§ `hoge` é–¢æ•°ã‚’ mock ã§ãã‚‹
        printer.expect_print().times(1).return_const(());

        printer_print(printer).await
    }
}
```

### `expect_method` ã«å¯¾ã—ã¦ã§ãã‚‹ã“ã¨

ref: [https://docs.rs/mockall/0.10.2/mockall/examples/\_\_mock\_MockFoo\_Foo/\_\_foo/struct.Expectation.html](https://docs.rs/mockall/0.10.2/mockall/examples/__mock_MockFoo_Foo/__foo/struct.Expectation.html)

# ã‚µãƒ³ãƒ—ãƒ«å®Ÿè£…

https://github.com/tktcorporation/discord-speech-bot/blob/d15b3239a8bb1fd09c4996295f21abba352cc5f3/src/handler/usecase/set_help_message_to_activity.rs#L19-L30

[https://github.com/tktcorporation/discord-speech-bot/blob/d15b3239a8bb1fd09c4996295f21abba352cc5f3/src/handler/usecase/set\_help\_message\_to\_activity.rs#L19-L30](https://github.com/tktcorporation/discord-speech-bot/blob/d15b3239a8bb1fd09c4996295f21abba352cc5f3/src/handler/usecase/set_help_message_to_activity.rs#L19-L30)